<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.sf.net">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="http://shopexts.googlecode.com/files/vul.css">
<TITLE>ECshop礼包id未过滤漏洞</TITLE>
</HEAD>
<BODY>

<DIV CLASS="header" ID="header">
<H1>ECshop礼包id未过滤漏洞</H1>
<H2>last modify 2011-07-20 15:27:19 Wednesday</H2>
</DIV>

<DIV CLASS="body" ID="body">
<H4>添加时间</H4>
<P>
2010-08-23
</P>
<H4>系统编号</H4>
<P>
SEC10082301
</P>
<H4>影响版本</H4>
<P>
ECShop  &lt;= 2.7.2
</P>
<H4>漏洞危害</H4>
<P>
成功利用该漏洞的攻击者可以获得数据库及站点的完全权限
</P>
<H4>漏洞原理</H4>
<P>
在include_libcommon.php中存在如下函数
</P>
<PRE>
function get_package_info($id)

{

    global $ecs, $db,$_CFG;



    $now = gmtime();



    $sql = "SELECT act_id AS id,  act_name AS package_name, goods_id , goods_name, start_time, end_time, act_desc, ext_info".

           " FROM " . $GLOBALS['ecs']-&gt;table('goods_activity') .

           " WHERE act_id='$id' AND act_type = " . GAT_PACKAGE;



    $package = $db-&gt;GetRow($sql);



    /* 将时间转成可阅读格式 */

    if ($package['start_time'] &lt;= $now &amp;&amp; $package['end_time'] &gt;= $now)

    {

        $package['is_on_sale'] = "1";

    }

    else

    {

        $package['is_on_sale'] = "0";

    }

    $package['start_time'] = local_date('Y-m-d H:i', $package['start_time']);

    $package['end_time']   = local_date('Y-m-d H:i', $package['end_time']);

    $row = unserialize($package['ext_info']);

    unset($package['ext_info']);

    if ($row)

    {

        foreach ($row as $key=&gt;$val)

        {

            $package[$key] = $val;

        }

    }



    $sql = "SELECT pg.package_id, pg.goods_id, pg.goods_number, pg.admin_id, ".

           " g.goods_sn, g.goods_name, g.market_price, g.goods_thumb, g.is_real, ".

           " IFNULL(mp.user_price, g.shop_price * '$_SESSION[discount]') AS rank_price " .

           " FROM " . $GLOBALS['ecs']-&gt;table('package_goods') . " AS pg ".

           "   LEFT JOIN ". $GLOBALS['ecs']-&gt;table('goods') . " AS g ".

           "   ON g.goods_id = pg.goods_id ".

           " LEFT JOIN " . $GLOBALS['ecs']-&gt;table('member_price') . " AS mp ".

                "ON mp.goods_id = g.goods_id AND mp.user_rank = '$_SESSION[user_rank]' ".

           " WHERE pg.package_id = " . $id. " ".

           " ORDER BY pg.package_id, pg.goods_id";



    $goods_res = $GLOBALS['db']-&gt;getAll($sql);



    $market_price        = 0;


</PRE>
<P></P>
<P>
函数参数$id没有做过滤，存在sql注入的可能。
</P>
<H4>检测方法</H4>
<P>
无
</P>
<H4>解决方案</H4>
<P>
ecshop团队发布安全补丁，补丁下载地址
</P>
<P>
<A HREF="http://bbs.ecshop.com/thread-136736-1-1.html">http://bbs.ecshop.com/thread-136736-1-1.html</A>
</P>
<H4>信息来源</H4>
<P>
 <A HREF="http://www.wooyun.org/bug.php?action=view&amp;id=248">http://www.wooyun.org/bug.php?action=view&amp;id=248</A>
</P>
</DIV>

<!-- html code generated by txt2tags 2.5 (http://txt2tags.sf.net) -->
<!-- cmdline: txt2tags -\-target=html -\-infile=t2t/10082301.t2t -\-outfile=htdocs/10082301.html -->
</BODY></HTML>
