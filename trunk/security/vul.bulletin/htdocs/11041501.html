<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.sf.net">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="http://shopexts.googlecode.com/files/vul.css">
<TITLE>ECshop XSS脚本跨站漏洞</TITLE>
</HEAD>
<BODY>

<DIV CLASS="header" ID="header">
<H1>ECshop XSS脚本跨站漏洞</H1>
<H2>last modify 2011-07-20 15:27:19 Wednesday</H2>
</DIV>

<DIV CLASS="body" ID="body">
<H4>添加时间</H4>
<P>
2011-04-15
</P>
<H4>系统编号</H4>
<H4>影响版本</H4>
<P>
ECShop  &lt;= 2.7.2
</P>
<H4>漏洞危害</H4>
<P>
成功利用该漏洞的攻击者可以在网站中插入恶意代码
</P>
<H4>漏洞原理</H4>
<P>
【1】在comment.php,未对$_GET['page']page为负数的情况下,进行判断。导致sql执行错误。
解决方法：$cmt-&gt;page = isset($_GET['page'])   &amp;&amp; intval($_GET['page'])  &gt; 0 ? intval($_GET['page'])  : 1;
【2】includes/cls_template.php 未对php其他php标签进行过滤。
解决方法：原         
$source = preg_replace("/&lt;\?[^&gt;&lt;]+\?&gt;/i", "", $source);
修改为
$source = preg_replace("/&lt;\?[^&gt;&lt;]+\?&gt;|&lt;\%[^&gt;&lt;]+\%&gt;|&lt;script[^&gt;]+language[^&gt;]*=[^&gt;]*php[^&gt;]*&gt;[^&gt;&lt;]*&lt;\/script\s*&gt;/iU", "", $source);
【3】category.php 对filter_attr进一步过滤
解决方法：
对 filter_attr 进行正则过滤 程序修改为：
$filter_attr_str = trim(urldecode($filter_attr_str));
$filter_attr_str = preg_match('/^[\d\.]+$/',$filter_attr_str) ? $filter_attr_str : '';
$filter_attr = empty($filter_attr_str) ? '' : explode('.', $filter_attr_str);
【4】admin/goods.php 变量未过滤extension_code
解决方案：admin/goods.php 112行添加
$code=$code=='virual_card' ? 'virual_card': '';
【5】/admin/privilege.php 对变量user_name和email过滤更改
解决方案： 
346 行去 $is_only = $exc-&gt;num('user_name', stripslashes($admin_name), $admin_id);
更改为
$is_only = $exc-&gt;num('user_name', $admin_name, $admin_id);
邮箱也做这样的处理
【6】admin/flow_stats.php 未对$_REQUEST['start_date']和$_REQUEST['end_date']进行判断
解决方案:
给默认值
    $start_date = empty($_REQUEST['start_date']) ? strtotime('-20 day') : intval($_REQUEST['start_date']);
    $end_date   = empty($_REQUEST['end_date']) ? time() : intval($_REQUEST['end_date']);
涉及修改的文件有：flow_stats.php、order_stats.php、searchengine_stats.php
</P>
<H4>检测方法</H4>
<P>
无
</P>
<H4>解决方案</H4>
<P>
ecshop团队发布安全补丁，补丁下载地址
<A HREF="http://bbs.ecshop.com/viewthread.php?tid=149969">http://bbs.ecshop.com/viewthread.php?tid=149969</A>
</P>
<P>
或者用 上面漏洞原理中的解决方法单个解决
</P>
<H4>信息来源</H4>
<P>
用户反馈
</P>
</DIV>

<!-- html code generated by txt2tags 2.5 (http://txt2tags.sf.net) -->
<!-- cmdline: txt2tags -\-target=html -\-infile=t2t/11041501.t2t -\-outfile=htdocs/11041501.html -->
</BODY></HTML>
