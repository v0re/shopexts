<DIV CLASS="body" ID="body"><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.sf.net">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<LINK REL="stylesheet" TYPE="text/css" HREF="statics/shopexdev.css">
<TITLE>ShopEx技术支持手册</TITLE>
</HEAD>
<BODY>
<H3>2.1.3. apache+mod_php</H3>
<P>
apache的php模块，利用apache强大的动态链接库功能，将php动态装载进apache的运行进程中，共享apache进程的上下文，除了使用非线程安全的自写php模板会造成apache进程崩溃外，找不到其他的缺点。
</P>
<P>
我们将所有的程序安装在/srv目录下，其结构如下：
</P>
<PRE>
/srv
|-- mysql
|-- apache
|-- php
`-- proftpd
</PRE>
<P></P>
<P>
每个程序安装到独立目录方便卸载,以下是详细过程
</P>
<H4>2.1.3.1. 编译apache的运行时apr</H4>
<P>
下载地址：
</P>
<P>
<A HREF="http://apache.mirror.phpchina.com/httpd/httpd-2.2.9.tar.bz2">http://apache.mirror.phpchina.com/httpd/httpd-2.2.9.tar.bz2</A>
</P>
<PRE>
tar jxvf httpd-2.2.9.tar.bz2
cd httpd-2.2.9
cd srclib/apr 
./configure --prefix=/srv/apache/apr 
make 
make install
</PRE>
<P></P>
<H4>2.1.3.2. 编译安装apache运行时工具包</H4>
<PRE>
cd ../apr-util
./configure --prefix=/svr/apache/apr-util --with-apr=/svr/apache/apr
make
make install
</PRE>
<P></P>
<H4>2.1.3.3. 编译安装apache</H4>
<PRE>
cd ../
./configure --prefix=/srv/apache --with-apr=/svr/apache/apr-httpd --with-apr-util=/svr/apache/apr-util --with-mpm=prefork --enable-so --enable-rewrite=shared --enable-track-vars
make
make install
</PRE>
<P>
编译指令说明
</P>
<OL>
<LI>--with-apr                                指定到apache运行时安装目录
<LI>--with-apr-util                        指定到apache运行时工具包的安装目录
<LI>--with-mpm=prefork            apache跑worker模式貌似不稳定，采用稳定的prefork模式
<LI>--enable-rewrite=shared     将rewrite编译为DSO，跟mod_php一样       
</OL>

<P>
配置apache启动脚本，拷贝一个apache控制脚本到linux的启动目录
</P>
<PRE>
cp support/apachectl /etc/rc.d/init.d/httpd
vi /etc/rc.d/init.d/httpd
</PRE>
<P>
在httpd文件的第三行，插入以下两句话:
</P>
<PRE>
#chkconfig: 345 85 15
#description: Starts and stops the Apache HTTP Server.
</PRE>
<P>
然后执行下面的命令，让apache随机启动
</P>
<PRE>
chmod +x /etc/rc.d/init.d/httpd
chkconfig --add httpd
chkconfig --level 345 httpd on
chkconfig --level 0126 httpd off
</PRE>
<P>
可以尝试执行下面的命令来启动apache
</P>
<PRE>
service httpd start
</PRE>
<P></P>
<P>
apache安装完毕后，就可以开始编译apache的php模块mod_php了。
</P>
<H4>2.1.3.4. 编译php的准备工作</H4>
<P>
编译php需要有gd库，zlib库，openssl库的支持，而gd要依赖freetype、jpeg、png库。
一般发行版如Redhat都会已经安装好了的。少数精简太厉害的vps预装的操作系统不一定会按照有，所以我们先检查我们需要的库
</P>
<OL>
<LI>检查zlib（gd、gzip用）
<PRE>
find /usr -name zlib.h
</PRE>
<LI>检查freetype（gd用）
<PRE>
find /usr -name freetype.h
</PRE>
<LI>检查jpeg头（gd用）
<PRE>
find /usr -name jpeglib.h
</PRE>
<LI>检查png头（gd用）
<PRE>
find /usr -name png.h
</PRE>
<LI>检查openssl头（php用）
<PRE>
find /usr/ -name ssl.h
</PRE>
搜索的结果中include前的部分就是我们在编译php是时指定用的，例如
<PRE>
[root@temp7 webadmin]# find /usr -name png.h
/usr/include/png.h
</PRE>
我们的编译指令就是--with-png-dir=/usr，如果检测不到，那个就要自己编译安装一下，为了简便起见，我采用POSIX标准，这些库的prefix我们都采用/usr，下面是安装过程，根据实际情况进行安装，一般Redhat Linux的可以直接跳过。
</OL>

<OL>
<LI>zlib
<PRE>
tar zxvf zlib-1.2.3.tar.gz
cd zlib-1.2.3
./configure --prefix=/usr/
make
make install
</PRE>
<LI>png
<PRE>
tar zxvf libpng-1.2.14.tar.gz 
cd libpng-1.2.14 
cp scripts/makefile.linux makefile 
sed -i 's/\/usr\/local/\/usr/' makefile
make 
make install
</PRE>
<LI>freetype
<PRE>
tar -zvxf freetype-2.1.10.tar.gz 
cd freetype-2.1.10 
mkdir -p /usr/local/freetype 
./configure --prefix=/usr/
make
make install
</PRE>
<LI>jpeg
<PRE>
tar zxvf jpegsrc.v6b.tar.gz 
./configure --prefix=/usr 
make 
make install 
make install-lib
</PRE>
make install的时候会报/usr/man1目录不存在，
```mkdir -pv /usr/man1
就行。
</OL>

<P>
从48版本开始不能再关闭xml库，编译xml库需要系统有libxml和libxml2，安装步骤参考：
</P>
<P>
<A HREF="http://www.linuxfromscratch.org/blfs/view/6.2.0/general/libxml.html">http://www.linuxfromscratch.org/blfs/view/6.2.0/general/libxml.html</A> 
</P>
<P>
<A HREF="http://www.linuxfromscratch.org/blfs/view/svn/general/libxml2.html">http://www.linuxfromscratch.org/blfs/view/svn/general/libxml2.html</A>
</P>
<H4>2.1.3.5. 编译mod_php</H4>
<P>
经过前面的准备工作后，可以下面编译指令编译mod_php
</P>
<PRE>
wget http://cn.php.net/get/php-5.2.6.tar.bz2/from/this/mirror
tar jxvf php-5.2.6.tar.bz2
cd php-5.2.6
'./configure' '--with-apxs2=/srv/apache/bin/apxs'  '--with-mysql=/srv/mysql' '--with-zlib-dir' '--with-freetype-dir=/usr' '--with-jpeg-dir=/usr' '--with-png-dir=/usr' '--enable-gd-native-ttf' '--with-gd' '--enable-track-vars' '--enable-ftp'  '--with-iconv'  '--with-openssl' 
make
make install
</PRE>
<OL>
<LI>--with-mysql                是安装mysql时的prefix，编译php的mysql客户端需要用到mysql的头和库文件
<LI>--with-gd                        只从gd的主力程序员给Zend打工后，php就不需要安装专门的gd库了
<LI>--with-apxs2                apache编译DSO用的脚本程序，apxs2帮我们生成合乎apache要求的Makefile
</OL>

<P>
顺利的话应该在30分钟内编译完毕，拷贝一份php.ini到/etc去
</P>
<PRE>
cp php.ini-dist /etc/php.ini
</PRE>
<P>
php5以前是直接读取服务器时间的，只要服务器时间正确，那边php脚本里的时间就正确，但是php5以后搞出了一个时区的概念。   必须在php.ini指定时区，找到date.timezone将它的值改为 
</P>
<PRE>
vi /etc/php.ini
</PRE>
<P>
将时区改一下
</P>
<PRE>
date.timezone = PRC
</PRE>
<P>
将时区设置为中华人民共和国
</P>
<H4>2.1.3.6. 配置apache</H4>
<OL>
<LI>apache的主配置文件在/srv/apache/conf/httpd.conf,打开apache的配置文件httpd.conf检查一下,如果有下面的语句
<PRE>
LoadModule php5_module        modules/libphp5.so
</PRE>
这句话是否有了，如果与了说明编译mod_php是成功的，可以继续下面的操作，如果没有则需要检查php编译指令。
<P></P>
<LI>设置默认页，加上index.htm和index.php
<PRE>
DirectoryIndex index.html index.htm index.php
</PRE>
<LI>新添加一种文件类型，在AddType application/x-gzip .gz .tgz后添加一句
<PRE>
AddType application/x-httpd-php .php
</PRE>
</OL>

</DIV></BODY></HTML>